<CTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Displaying text directions with <code>setPanel()</code></title>
    <link rel="stylesheet" type="text/css" href="mystyle.css">
  </head>

  <body>
      <strong>Mode:</strong>
         <select id="mode">
           <option value="chicago, il">Driving</option>
           <option value="st louis, mo">Walking</option>
           <option value="joplin, mo">Transit</option>
           <option value="oklahoma city, ok">Bicycle</option>
         </select>
         <br>
      <strong>Start:</strong>
        <input type="text" name="start" id="start">
       <input type="updateMap" value="Update Map" onclick="updateMap()">
      <br>
      <strong>End:</strong>
       <input type="text" name="end"  id="end">
      <br>
       <input type="submit" value="Submit" onclick="onChangeHandler()">

    <div id="floating-panel"></div>
    <div id="right-panel"></div>
    <div id="map-panel"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>
      function initMap() {
        geoHome = {lat: 34.0219, lng: -118.4814}; //Santa Monica
        geocoder = new google.maps.Geocoder();

        var directionsDisplay = new google.maps.DirectionsRenderer;
        var directionsService = new google.maps.DirectionsService;
        map = new google.maps.Map(document.getElementById('map-panel'), {
          zoom: 13,
          center: geoHome
        });

        directionsDisplay.setMap(map);
        directionsDisplay.setPanel(document.getElementById('right-panel'));

        var control = document.getElementById('floating-panel');
        control.style.display = 'block';
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(control);

        onChangeHandler = function() {
          calculateAndDisplayRoute(directionsService, directionsDisplay);
        };

        var input = (document.getElementById('start'));
        var autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo('bounds', map);
        autocomplete.addListener('place_changed', function() {});

        var input2 = (document.getElementById('end'));
        var autocomplete2 = new google.maps.places.Autocomplete(input2);
        autocomplete2.bindTo('bounds', map);
        autocomplete2.addListener('place_changed', function() {});

        makeMarker();
      }

      function makeMarker() {
        var infowindow = new google.maps.InfoWindow();
        var stopAPI = "/google/stops.json"
              $.getJSON( stopAPI, { })
              .done(function( data ) {
                 $.each( data, function( i, item )     {
                   var latitude = item.stop_lat;
                   var longitude = item.stop_lon;
                   var desc = item.stop_desc;
                   var name = item.stop_name;
                   var id = item.stop_id;
                   var stop = {};
                   stop = {
                     "latitude":  latitude,
                     "longitude": longitude,
                     "desc":  desc,
                     "name":  name,
                     "id":  id
		   }
                   console.log(item.stop_lon);
		   var stopLatLng = new google.maps.LatLng(latitude, longitude);
		   var marker = new google.maps.Marker({position: stopLatLng, map: map, title: 'foo'});

                   routes = getRoutes(id, "xxx");
                   for (var i=0; i<routes.length; i++) {
                         var obj = routes[i];
                         console.log(obj.headsign);
                   }
                    html='<IMG BORDER="0" ALIGN ="Left">'
		    +
                    '<div id="siteNotice">'+
                    '</div>'+
                    '<h1 id="stopName" class="stopName">' + desc + '</h1>' +
                    '<div id="bodyContent">'+
                    '<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large '               +
                    'sandstone rock formation in the southern part of the '+
                    'Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) '+
                    'south west of the nearest large town, Alice Springs; 450&#160;km '+
                    '(280&#160;mi) by road. Kata Tjuta and Uluru are the two major '+
                    'features of the Uluru - Kata Tjuta National Park. Uluru is '+
                    'sacred to the Pitjantjatjara and Yankunytjatjara, the '+
                    'Aboriginal people of the area. It has many springs, waterholes, '+
                    'rock caves and ancient paintings. Uluru is listed as a World '+
                    'Heritage Site.</p>'+
                    '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">'+
                    'https://en.wikipedia.org/w/index.php?title=Uluru</a> '+
                    '(last visited June 22, 2009).</p>'+
                    '</div>'+
                    '</div>' ;
		   var infowindow = new google.maps.InfoWindow(
                    {content:html});
               google.maps.event.addListener(marker, 'click', function() { infowindow.open(map,marker,stop); });
               });
             });
      }

      function getRoutes(stopId, time) {
//Build an internal API that given a stopId, returns a list of route names, headsigns, and departure times.
//efective sql would be:
//
//select route_short_name, trips.trip_headsign, MIN(departure_time) from stop_times inner join trips on stop_times.trip_id = trips.trip_id inner join routes on trips.route_id=routes.route_id inner join stops on stop_times.stop_id = stops.stop_id where departure_time > '17:18:00' AND trips.service_id = '20160221_10' and stops.stop_id ='4' GROUP BY route_short_name, trips.trip_headsign; 
          
        data = 
[
 {
   name: "2",
   headsign: "To Beach",
   departure: "12:45"
 },
 {
   name: "8",
   headsign: "To Downtown",
   departure: "12:45"
 },
 {
   name: "9",
   headsign: "To Museum",
   departure: "12:45"
 }
];

          return data;
      }
      function updateMap() {
        var geoOrigin = document.getElementById('start').value;

        geocoder.geocode( { 'address': geoOrigin}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          var originMarker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
          });

          var homeMarker = new google.maps.Marker({
            map: map,
            position: geoHome
          });

          var bounds = new google.maps.LatLngBounds();
          bounds.extend(originMarker.position);
          bounds.extend(homeMarker.position);
          map.fitBounds(bounds);

        } else {
           alert("Geocode was not successful for the following reason: " + status);
        }
       });
      }


      function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        var start = document.getElementById('start').value;
        var end = document.getElementById('end').value;
        directionsService.route({
          origin: start,
          destination: end,
          travelMode: google.maps.TravelMode.DRIVING
        }, function(response, status) {
          if (status === google.maps.DirectionsStatus.OK) {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvt59m6292BfxRwEPJnSSzv-jaVY8pNT4&callback=initMap&libraries=places">
    </script>
  </body>
</html>
